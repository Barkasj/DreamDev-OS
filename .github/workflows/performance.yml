name: âš¡ Performance & Quality Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every day at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ===== LIGHTHOUSE PERFORMANCE =====
  lighthouse:
    name: ðŸ® Lighthouse Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'prompt-orchestrator-frontend/package-lock.json'
          
      - name: ðŸ“¥ Install dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm ci
        
      - name: ðŸ—ï¸ Build application
        working-directory: ./prompt-orchestrator-frontend
        run: npm run build
        
      - name: ðŸš€ Start application
        working-directory: ./prompt-orchestrator-frontend
        run: |
          npm start &
          sleep 30
        env:
          PORT: 3000
          
      - name: ðŸ® Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: ðŸ“Š Upload Lighthouse results
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-results
          path: .lighthouseci
          retention-days: 30

  # ===== BUNDLE ANALYSIS =====
  bundle-analysis:
    name: ðŸ“¦ Bundle Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'prompt-orchestrator-frontend/package-lock.json'
          
      - name: ðŸ“¥ Install dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm ci
        
      - name: ðŸ“¦ Analyze bundle
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "ðŸ“¦ Analyzing bundle size..."
          npm run build
          
          # Install bundle analyzer
          npm install -g webpack-bundle-analyzer
          
          # Generate bundle report
          npx next build --profile
          
      - name: ðŸ“Š Bundle size report
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "# ðŸ“¦ Bundle Size Report" > bundle-report.md
          echo "" >> bundle-report.md
          echo "Generated on: $(date)" >> bundle-report.md
          echo "" >> bundle-report.md
          
          echo "## ðŸ“Š Build Output" >> bundle-report.md
          echo '```' >> bundle-report.md
          npm run build 2>&1 | tail -20 >> bundle-report.md
          echo '```' >> bundle-report.md
          
          cat bundle-report.md
          
      - name: ðŸ“¤ Upload bundle report
        uses: actions/upload-artifact@v3
        with:
          name: bundle-analysis
          path: prompt-orchestrator-frontend/bundle-report.md
          retention-days: 30

  # ===== CODE QUALITY METRICS =====
  code-quality:
    name: ðŸ“Š Code Quality Metrics
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'prompt-orchestrator-frontend/package-lock.json'
          
      - name: ðŸ“¥ Install dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm ci
        
      - name: ðŸ§ª Run tests with coverage
        working-directory: ./prompt-orchestrator-frontend
        run: npm run test:coverage
        
      - name: ðŸ“Š SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: prompt-orchestrator-frontend
          
      - name: ðŸ“Š Generate quality report
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "# ðŸ“Š Code Quality Report" > quality-report.md
          echo "" >> quality-report.md
          echo "Generated on: $(date)" >> quality-report.md
          echo "" >> quality-report.md
          
          echo "## ðŸ§ª Test Coverage" >> quality-report.md
          if [ -f coverage/coverage-summary.json ]; then
            echo "- Statements: $(cat coverage/coverage-summary.json | jq '.total.statements.pct')%" >> quality-report.md
            echo "- Branches: $(cat coverage/coverage-summary.json | jq '.total.branches.pct')%" >> quality-report.md
            echo "- Functions: $(cat coverage/coverage-summary.json | jq '.total.functions.pct')%" >> quality-report.md
            echo "- Lines: $(cat coverage/coverage-summary.json | jq '.total.lines.pct')%" >> quality-report.md
          fi
          echo "" >> quality-report.md
          
          echo "## ðŸ“ File Statistics" >> quality-report.md
          echo "- TypeScript files: $(find src -name '*.ts' -o -name '*.tsx' | wc -l)" >> quality-report.md
          echo "- Test files: $(find src -name '*.test.*' -o -name '*.spec.*' | wc -l)" >> quality-report.md
          echo "- Component files: $(find src/components -name '*.tsx' | wc -l)" >> quality-report.md
          echo "" >> quality-report.md
          
          echo "## ðŸ” Code Complexity" >> quality-report.md
          echo "- Total lines of code: $(find src -name '*.ts' -o -name '*.tsx' | xargs wc -l | tail -1 | awk '{print $1}')" >> quality-report.md
          
          cat quality-report.md
          
      - name: ðŸ“¤ Upload quality report
        uses: actions/upload-artifact@v3
        with:
          name: code-quality-report
          path: prompt-orchestrator-frontend/quality-report.md
          retention-days: 30

  # ===== ACCESSIBILITY TESTING =====
  accessibility:
    name: â™¿ Accessibility Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'prompt-orchestrator-frontend/package-lock.json'
          
      - name: ðŸ“¥ Install dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm ci
        
      - name: ðŸ—ï¸ Build application
        working-directory: ./prompt-orchestrator-frontend
        run: npm run build
        
      - name: ðŸš€ Start application
        working-directory: ./prompt-orchestrator-frontend
        run: |
          npm start &
          sleep 30
        env:
          PORT: 3000
          
      - name: â™¿ Run accessibility tests
        run: |
          npm install -g @axe-core/cli
          
          echo "â™¿ Running accessibility tests..."
          axe http://localhost:3000 --save accessibility-report.json || true
          
      - name: ðŸ“Š Generate accessibility report
        run: |
          echo "# â™¿ Accessibility Report" > accessibility-summary.md
          echo "" >> accessibility-summary.md
          echo "Generated on: $(date)" >> accessibility-summary.md
          echo "" >> accessibility-summary.md
          
          if [ -f accessibility-report.json ]; then
            violations=$(cat accessibility-report.json | jq '.violations | length')
            echo "- Total violations: $violations" >> accessibility-summary.md
            
            if [ "$violations" -eq 0 ]; then
              echo "- âœ… No accessibility violations found!" >> accessibility-summary.md
            else
              echo "- âš ï¸ Accessibility issues detected" >> accessibility-summary.md
            fi
          else
            echo "- âŒ Could not generate accessibility report" >> accessibility-summary.md
          fi
          
          cat accessibility-summary.md
          
      - name: ðŸ“¤ Upload accessibility report
        uses: actions/upload-artifact@v3
        with:
          name: accessibility-report
          path: |
            accessibility-report.json
            accessibility-summary.md
          retention-days: 30

  # ===== PERFORMANCE SUMMARY =====
  performance-summary:
    name: ðŸ“‹ Performance Summary
    runs-on: ubuntu-latest
    needs: [lighthouse, bundle-analysis, code-quality, accessibility]
    if: always()
    
    steps:
      - name: ðŸ“¥ Download all reports
        uses: actions/download-artifact@v3
        
      - name: ðŸ“‹ Generate performance summary
        run: |
          echo "# âš¡ Performance & Quality Summary" > performance-summary.md
          echo "" >> performance-summary.md
          echo "Generated on: $(date)" >> performance-summary.md
          echo "" >> performance-summary.md
          
          echo "## ðŸ“Š Report Status" >> performance-summary.md
          echo "" >> performance-summary.md
          
          if [ "${{ needs.lighthouse.result }}" == "success" ]; then
            echo "- âœ… Lighthouse: Passed" >> performance-summary.md
          else
            echo "- âŒ Lighthouse: Failed" >> performance-summary.md
          fi
          
          if [ "${{ needs.bundle-analysis.result }}" == "success" ]; then
            echo "- âœ… Bundle Analysis: Passed" >> performance-summary.md
          else
            echo "- âŒ Bundle Analysis: Failed" >> performance-summary.md
          fi
          
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "- âœ… Code Quality: Passed" >> performance-summary.md
          else
            echo "- âŒ Code Quality: Failed" >> performance-summary.md
          fi
          
          if [ "${{ needs.accessibility.result }}" == "success" ]; then
            echo "- âœ… Accessibility: Passed" >> performance-summary.md
          else
            echo "- âŒ Accessibility: Failed" >> performance-summary.md
          fi
          
          echo "" >> performance-summary.md
          echo "## ðŸ”— Detailed Reports" >> performance-summary.md
          echo "Check the individual artifacts for detailed analysis." >> performance-summary.md
          
          cat performance-summary.md
          
      - name: ðŸ“¤ Upload performance summary
        uses: actions/upload-artifact@v3
        with:
          name: performance-summary
          path: performance-summary.md
          retention-days: 30
          
      - name: ðŸ“¢ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('performance-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });