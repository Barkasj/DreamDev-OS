name: ðŸ”„ Auto Update Dependencies

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  NODE_VERSION: '18'

jobs:
  # ===== AUTO UPDATE DEPENDENCIES =====
  auto-update:
    name: ðŸ”„ Auto Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'prompt-orchestrator-frontend/package-lock.json'
          
      - name: ðŸ“¥ Install dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm ci
        
      - name: ðŸ“¥ Install npm-check-updates
        run: npm install -g npm-check-updates
        
      - name: ðŸ”„ Update patch versions
        if: github.event.inputs.update_type == 'patch' || github.event_name == 'schedule'
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "ðŸ”„ Updating patch versions..."
          ncu -u --target patch
          
      - name: ðŸ”„ Update minor versions
        if: github.event.inputs.update_type == 'minor'
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "ðŸ”„ Updating minor versions..."
          ncu -u --target minor
          
      - name: ðŸ”„ Update major versions
        if: github.event.inputs.update_type == 'major'
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "ðŸ”„ Updating major versions..."
          ncu -u --target latest
          
      - name: ðŸ“¦ Install updated dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm install
        
      - name: ðŸ§ª Run tests
        working-directory: ./prompt-orchestrator-frontend
        run: npm test
        
      - name: ðŸ—ï¸ Test build
        working-directory: ./prompt-orchestrator-frontend
        run: npm run build
        
      - name: ðŸ” Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ“ Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ Auto-update dependencies (${{ github.event.inputs.update_type || 'patch' }})
            
            - Updated dependencies to latest ${{ github.event.inputs.update_type || 'patch' }} versions
            - All tests passing
            - Build successful
          title: 'ðŸ”„ Auto-update dependencies (${{ github.event.inputs.update_type || 'patch' }})'
          body: |
            ## ðŸ”„ Automated Dependency Update
            
            This PR was automatically created to update dependencies to their latest ${{ github.event.inputs.update_type || 'patch' }} versions.
            
            ### âœ… Checks Performed
            - ðŸ§ª All tests passing
            - ðŸ—ï¸ Build successful
            - ðŸ” No breaking changes detected
            
            ### ðŸ“‹ Changes
            - Updated package.json with latest ${{ github.event.inputs.update_type || 'patch' }} versions
            - Updated package-lock.json
            
            ### ðŸ” Review Required
            Please review the changes and ensure everything works as expected before merging.
            
            ---
            *This PR was created automatically by the Auto Update Dependencies workflow.*
          branch: auto-update-dependencies-${{ github.run_number }}
          delete-branch: true
          draft: false
          
      - name: ðŸ“¢ Notify if no changes
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "âœ… No dependency updates available!"
          echo "All dependencies are already up to date."

  # ===== SECURITY UPDATE =====
  security-update:
    name: ðŸ›¡ï¸ Security Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'prompt-orchestrator-frontend/package-lock.json'
          
      - name: ðŸ“¥ Install dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm ci
        
      - name: ðŸ›¡ï¸ Fix security vulnerabilities
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "ðŸ›¡ï¸ Fixing security vulnerabilities..."
          npm audit fix --force || true
          
      - name: ðŸ§ª Run tests after security fixes
        working-directory: ./prompt-orchestrator-frontend
        run: npm test
        
      - name: ðŸ—ï¸ Test build after security fixes
        working-directory: ./prompt-orchestrator-frontend
        run: npm run build
        
      - name: ðŸ” Check for security changes
        id: security_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ“ Create Security PR
        if: steps.security_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ›¡ï¸ Security: Fix dependency vulnerabilities
            
            - Applied npm audit fix
            - All tests passing
            - Build successful
          title: 'ðŸ›¡ï¸ Security: Fix dependency vulnerabilities'
          body: |
            ## ðŸ›¡ï¸ Security Vulnerability Fixes
            
            This PR was automatically created to fix security vulnerabilities found in dependencies.
            
            ### âœ… Checks Performed
            - ðŸ§ª All tests passing
            - ðŸ—ï¸ Build successful
            - ðŸ›¡ï¸ Security vulnerabilities addressed
            
            ### ðŸ“‹ Changes
            - Applied `npm audit fix`
            - Updated vulnerable dependencies
            
            ### âš ï¸ Important
            This is a **security update** and should be reviewed and merged promptly.
            
            ---
            *This PR was created automatically by the Security Update workflow.*
          branch: security-update-${{ github.run_number }}
          delete-branch: true
          draft: false
          labels: |
            security
            dependencies
            
      - name: ðŸ“¢ Notify if no security issues
        if: steps.security_changes.outputs.has_changes == 'false'
        run: |
          echo "âœ… No security vulnerabilities found!"
          echo "All dependencies are secure."

  # ===== DEPENDENCY HEALTH CHECK =====
  health-check:
    name: ðŸ¥ Dependency Health Check
    runs-on: ubuntu-latest
    needs: [auto-update, security-update]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'prompt-orchestrator-frontend/package-lock.json'
          
      - name: ðŸ“¥ Install dependencies
        working-directory: ./prompt-orchestrator-frontend
        run: npm ci
        
      - name: ðŸ¥ Generate health report
        working-directory: ./prompt-orchestrator-frontend
        run: |
          echo "# ðŸ¥ Dependency Health Report" > health-report.md
          echo "" >> health-report.md
          echo "Generated on: $(date)" >> health-report.md
          echo "" >> health-report.md
          
          echo "## ðŸ“Š Package Statistics" >> health-report.md
          echo "- Total dependencies: $(npm ls --depth=0 --json | jq '.dependencies | length')" >> health-report.md
          echo "- Dev dependencies: $(npm ls --depth=0 --json | jq '.devDependencies | length')" >> health-report.md
          echo "" >> health-report.md
          
          echo "## ðŸ” Audit Results" >> health-report.md
          npm audit --json > audit.json || true
          if [ -s audit.json ]; then
            echo "- Vulnerabilities found: $(cat audit.json | jq '.metadata.vulnerabilities.total')" >> health-report.md
            echo "- High severity: $(cat audit.json | jq '.metadata.vulnerabilities.high')" >> health-report.md
            echo "- Moderate severity: $(cat audit.json | jq '.metadata.vulnerabilities.moderate')" >> health-report.md
            echo "- Low severity: $(cat audit.json | jq '.metadata.vulnerabilities.low')" >> health-report.md
          else
            echo "- âœ… No vulnerabilities found!" >> health-report.md
          fi
          echo "" >> health-report.md
          
          echo "## ðŸ“… Outdated Packages" >> health-report.md
          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "- Outdated packages found: $(cat outdated.json | jq 'keys | length')" >> health-report.md
          else
            echo "- âœ… All packages are up to date!" >> health-report.md
          fi
          
          cat health-report.md
          
      - name: ðŸ“¤ Upload health report
        uses: actions/upload-artifact@v3
        with:
          name: dependency-health-report
          path: prompt-orchestrator-frontend/health-report.md
          retention-days: 30